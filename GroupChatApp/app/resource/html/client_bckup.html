<!DOCTYPE html>
<html>
<head>
<title>ICS: Chat Room</title>
<meta charset="UTF-8">
<script type="text/javascript"
	src="##APPLICATION_CONTEXT##/resource/js/jqsm.js"></script>
<script type="text/javascript"
	src="##APPLICATION_CONTEXT##/resource/js/loader.js"></script>
<script type="text/javascript"
	src="##APPLICATION_CONTEXT##/resource/js/user.js"></script>
<link rel="stylesheet" type="text/css"
	href="##APPLICATION_CONTEXT##/resource/css/styler.css">
<link rel="shortcut icon" type="image/x-icon"
	href="##APPLICATION_CONTEXT##/resource/images/favicon.ico" />
<script type="text/javascript">
	var isWindowActive = true;
	$(function() {
// 		$(this).bind("contextmenu", function(e) {
//             e.preventDefault();
//         });

// 		$(window).on('unload', function() {
// 			if($('#page-unload-status').val() === 'close')
//  				$('#logout-btn').click();
// 		});

// 		$(window).on('keydown', function(e){
// 			// F12=123, I=73 (Ctrl+Shift+I), F5= ,R=82
// 			var allowKey = event.keyCode == 123
// 						   || (event.keyCode == 73 && event.shiftKey && event.ctrlKey)
// 						   || (event.keyCode == 82 && event.ctrlKey)
// 						   || event.keyCode == 116;
// 			if(allowKey) {
// 				e.preventDefault();
// 			}
// 		});

		$(window).blur(function(){
			  isWindowActive = false;
		});
		$(window).focus(function(){
				isWindowActive = true;
		});
		String.prototype.replaceAll = function(search, replacement) {
		    var target = this;
		    return target.replace(new RegExp(search, 'g'), replacement);
		};

		$('#msg-in-box').focus();

		getAllUsers();
		loadAllMessages();
// 		loadAllEmojis();

		$('#msg-in-box').on('keyup', function() {
			if (!event.shiftKey) {
				var key = event.keyCode || event.charCode;
				if (key == 13) {
					$('#send-btn').submit();
				}
			}
		});
		$('#chat-form').submit(function(e) {
			var content = $('#msg-in-box').html();
			content = content.replaceAll('<div><br></div>', '\n');
			if (content.endsWith("\r\n")) {
				content = content.substring(0, msg.length - 2);
			} else if (content.endsWith("\n")) {
				content = content.substring(0, content.length - 1);
			}

			var regex = /(<img src=\"data:image\/png;base64, [\w\W]+? alt=\"\" height=\"20\" width=\"20\">)/igm;
			var match = regex.exec(content);
			while(match != null) {
				var imgText = match[0];
				var img = $(imgText);
				var data = img.attr('src').replace('data:image/png;base64, ', '');
				content = content.replace(imgText, '\\\\' + data + '\/\/');
				var regex = /(<img src=\"data:image\/png;base64, [\w\W]+? alt=\"\" height=\"20\" width=\"20\">)/igm;
				match = regex.exec(content);
				console.log(match);
			}

			$('#msg-in-box-content').val(content.trim());

			if ($('#msg-in-box-content').val() !== "") {
				$('#send-id').val(1);
				sendPostData();
			}
			$('#msg-in-box').focus();
			e.preventDefault();
		});

		$("#msg-in-box").bind("paste", function(e){
 		    e.preventDefault();
		    var pastedData = e.originalEvent.clipboardData.getData('text');
		    document.execCommand("insertHTML", false, pastedData);
		} );

		$('#reload-btn').click(function(e) {
			$('#page-unload-status').val('reload')
			window.location.reload(true);
		});

		$('#logout-btn').click(function(e) {
			$('#send-id').val(2);
			sendPostData();
			e.preventDefault();
		});

		var size = [ window.outerWidth, window.outerHeight ];

		$('#err-box').bind("DOMSubtreeModified",function(){
			if($('#err-box').text() != ''){
				allowResize = true;
				size = [ window.outerWidth, window.outerHeight + 27 ];
				$( window ).resize();
				$('#err-box').fadeOut(10000,'linear', function(){
					$('#err-box').empty();
					$('#err-box').show();
					allowResize = true;
					size = [ window.outerWidth, window.outerHeight - 27 ];
					$( window ).resize();
				});
			}
		});

		##SPECIAL_APPENDER_EVENT##


		$(window).resize(function() {
			window.resizeTo(size[0], size[1]);
		});

		if (Notification.permission !== "granted")
		    Notification.requestPermission();
	});

	function notifyMe() {
		if (Notification.permission !== "granted")
			Notification.requestPermission();
		else {
			var a = $('#my-name').text();
			a = a.substring(a.lastIndexOf(':')+1, a.length)

		    var notification = new Notification('Hi ' + a + '!', {
		      icon: '##APPLICATION_CONTEXT##/resource/images/cr.png',
		      body: "You have a new message.",
		    });
			$(notification).css('cursor', 'pointer');
		    notification.onclick = function () {
		    	window.focus();
		    	notification.close();
		    };
		}
	}

	function findMe() {
		var a = $(location).attr('href');
		var t = a.substring(a.indexOf("?")).split("=")[1];
		$('#token').val(t);
		$('#send-id').val(0);
		sendPostData();
	}

	function sendPostData() {
		var form = $('#chat-form');
		var postData = form.serializeArray();
		var formURL = form.attr("action");
		var type = form.attr("method");
		var sendId = parseInt($('#send-id').val());

		var jqXhr = $.ajax({
			url : formURL,
			type : type,
			data : postData,
		});

		jqXhr
				.done(function(data) {
					switch (sendId) {
					case 1:
						if (data === 'true') {
							$('#msg-in-box').empty();
							$('#msg-in-box-content').val('');
							$('#err-box').empty();
						} else if (data === 'false') {
							$('#err-box').text(
									"Could not send message. Please retry!");
						} else {
							window.location.replace('##APPLICATION_CONTEXT##/err');
						}
						break;
					case 2:
						if (data === '0') {
							if (w1 != "undefined") {
								w1.terminate();
								w1 = undefined;
							}
							if (w2 != "undefined") {
								w2.terminate();
								w2 = undefined;
							}
							window.location.replace('##APPLICATION_CONTEXT##/init');
						} else {
							$('#err-box').text(
									"Could not logout. Please retry!");
						}
						break;
						##SPECIAL_APPENDER_CASE##
					}
				});
	}

	function loadAllMessages() {
		var jqXhr = $.ajax({
			type : "GET",
			url : "##APPLICATION_CONTEXT##/recover",
		});

		jqXhr
				.done(function(data) {
					if (data !== null && data !== 'false') {
						messageAppender(data);
						$('#err-box').empty();
					} else {
						$('#err-box')
								.text(
										"Could not load previous messages. Please retry by refreshing!");
					}
					startChatWorker();
				});
	}

	function startChatWorker() {
		if (typeof (Worker) !== "undefined") {
			if (typeof (w2) == "undefined") {
				w2 = new Worker(URL.createObjectURL(new Blob([ "("
						+ loadMsg.toString() + ")()" ], {
					type : 'text/javascript'
				})));
			}
			var url = $(location).attr('origin') + "##APPLICATION_CONTEXT##/load?msgId="
					+ $('#last-msg-id').val() + "&token=" + $('#token').val();
			w2.postMessage(url);
			w2.addEventListener('message', function(e) {
				if (e.data !== '' && e.data !== 'false') {
					if (e.data === "-1") {
						window.location.replace('##APPLICATION_CONTEXT##/err');
					} else {
						var response = JSON.parse(e.data);
						messageAppender(response);

						if(!isWindowActive)
							notifyMe();
					}
				}
				url = $(location).attr('origin') + "##APPLICATION_CONTEXT##/load?msgId="
						+ $('#last-msg-id').val() + "&token="
						+ $('#token').val();
				w2.postMessage(url);
			}, false);
		} else {
			alert("Can't execute Chatroom. Upgrade your browser to modern one!!");
		}
	}

	function getAllUsers() {
		var jqXhr = $.ajax({
			type : "GET",
			url : "##APPLICATION_CONTEXT##/allusers?token=" + $('#token').val(),
		});

		jqXhr
				.done(function(data) {
					if (data !== null && data !== 'false') {
						$.each(data, function(i, item) {
							$('#user-list').append('<div class="u-details"><span class="users">'
									+ '<div class="status s-off"></div> '
									+ item.rname
									+ '</span><input type="hidden" value="'
									+ item.uname +'" class="users-uname"></div>');
						});
						startUserWorker();
					} else 	if (data === "-1") {
						window.location.replace('##APPLICATION_CONTEXT##/err');
					}
				});
	}

	function loadAllEmojis(){
		var jqXhr = $.ajax({
			type : "GET",
			url : "##APPLICATION_CONTEXT##/emoji?token=" + $('#token').val(),
		});

		jqXhr
				.done(function(data) {
					if (data !== null && data !== 'false') {
						$.each(data, function(i, item) {
							var div = $('<div class="emoji-div"></div>');
							$('#emoji-container').append(div);
							var img = $('<img src="data:image/png;base64, '+ item.data + '" alt="' + item.name + '" alt=" title=' + item.name + '" height="20" width="20" />');
							div.append(img);

							img.click(function(){
								var newImg = $(this).clone();
								$('#msg-in-box').append(newImg);
							});
						});
						startUserWorker();
					} else 	if (data === "-1") {
						window.location.replace('##APPLICATION_CONTEXT##/err');
					}
				});
	}

	function startUserWorker() {
		if (typeof (Worker) !== "undefined") {
			if (typeof (w1) == "undefined") {
				w1 = new Worker(URL.createObjectURL(new Blob([ "("
						+ loadUsers.toString() + ")()" ], {
					type : 'text/javascript'
				})));
			}
			var url = $(location).attr('origin') + "##APPLICATION_CONTEXT##/users?token="
					+ $('#token').val();
			w1.postMessage(url);
			w1.addEventListener('message', function(e) {
				if (e.data !== "") {
					if (e.data === "-1") {
						window.location.replace('##APPLICATION_CONTEXT##/err');
					} else {
						var data = JSON.parse(e.data);
						$('.s-on').removeClass('.s-on').addClass('s-off');
						$.each(data, function(i, item) {
							var elem = $('.u-details').find('.users-uname:input[value="' + item.uname + '"]');

							if(elem != undefined && elem != null && elem.length > 0) {
								$(elem.parent().find('.status')[0]).removeClass('s-off').addClass('s-on');
							}
						});
					}
				} else {
					$('.s-on').removeClass('.s-on').addClass('s-off');
				}
				url = $(location).attr('origin') + "##APPLICATION_CONTEXT##/users?token="
						+ $('#token').val();
				w1.postMessage(url);
			}, false);
		} else {
			alert("Can't execute Chatroom. Upgrade your browser to modern one!!");
		}
	}

	function messageAppender(response) {
		for (var i = 0; i < response.length; i++) {
			var msgs = $('.msg');
			var lastTd = $(msgs[msgs.length - 1]);

			var lastSender = lastTd.find('.sender-ids').val();
			var lastSentAt = lastTd.find('.ts').text();
			lastSentAt = lastSentAt.substring(lastSentAt.indexOf('@')+1);
			var ts = response[i].sentTimestamp;
			ts = ts.substring(0, ts.lastIndexOf(':'));


			var dtGrp = getDateGroupDiv(ts);
			if(dtGrp !== null) {
				$('#content-body').append(dtGrp);
			}

			var elP;
			if(lastSender === response[i].username && lastSentAt === ts){
				var textContentP = elP =lastTd.find('p.text-content');
				var text = textContentP.text()
				textContentP.empty();
				textContentP.text(text+'\n'+response[i].message);
				lastTd.find('.msg-ids').val(response[i].messageId);
			} else {
				var tr = $('<tr></tr>');
				var td = $('<td class="msg">'
						+ '<input type="hidden" class="msg-ids" value="'+response[i].messageId+'">'
						+ '<input type="hidden" class="sender-ids" value="'+response[i].username+'">'
						+ '</td>');

				var msgMain = $('<div class="msg-main"></div>');
				var msgDiv = $('<div class="msg-div"></div>');
				var tsDiv = $('<div class="ts-div"></div>');
				var p1 = elP = $('<p class="text-content"></p>').text(
						response[i].senderName + ': ' + response[i].message);

				var p2 = '<p class="ts">Sent @' + ts + '</p>';

				$('#content-body').append(tr);
				tr.append(td);
				td.append(msgMain);
				msgMain.append(msgDiv);
				msgDiv.append(p1);
				msgMain.append(tsDiv);
				tsDiv.append(p2);
				tsDiv.hide();
				p1.click(function(){
					var parent = $(this).parent().parent().parent().parent();
					var isLast = parent.is(':last-child');

					var duration = 0;
					if(!isLast)
						duration = 500;

					parent.find('.ts-div').fadeToggle(duration, function() {
						if(isLast)
							scrollToBottom();
					});
				});

				var username = response[i].username;
				if (username === $('#uname').val()) {
					td.addClass('msg-right');
					msgDiv.addClass('msg-self');
				} else {
					td.addClass('msg-left');
					msgDiv.addClass('msg-other');
				}
			}

			var content = elP.html();
			var regEx = /(https?:\/\/([-\w\.]+)+(:\d+)?(\/([\w\/_\.]*(\?\S+)?)?)?)/igm;

			var match = regEx.exec(content);
			while(match != null) {
				var link = match[0];
				var actLink = '<a href="'+link+'" target="_blank">'+link+'</a>';
				p1.html(content.replace(link, actLink));
				match = regEx.exec(content);
			}
		}
		setLastMsgId();
		scrollToBottom();
	}

	function scrollToBottom() {
		var content = $('#content');
		var height = content[0].scrollHeight;
		content.scrollTop(height);
	}

	function getDateGroupDiv(ts) {
		var tsLast = $('.ts:last');
		var proceed = true;
		var lastTs = ts.substring(0, ts.lastIndexOf(' '));

		if(tsLast.length > 0 ){
			var lastSentAt = tsLast.text();
			lastSentAt = lastSentAt.substring(lastSentAt.indexOf('@')+1, lastSentAt.lastIndexOf(' '));
			proceed = lastSentAt === lastTs ? false : true;
		}

		if(proceed){
			var dateParts = lastTs.split('-');
			var dtGrp = dateParts[0] + ' ';
			switch(parseInt(dateParts[1])) {
			case 1:
				dtGrp += 'JAN' + ' ';
				break;
			case 2:
				dtGrp += 'FEB' + ' ';
				break;
			case 3:
				dtGrp += 'MAR' + ' ';
				break;
			case 4:
				dtGrp += 'APR' + ' ';
				break;
			case 5:
				dtGrp += 'MAY' + ' ';
				break;
			case 6:
				dtGrp += 'JUN' + ' ';
				break;
			case 7:
				dtGrp += 'JUL' + ' ';
				break;
			case 8:
				dtGrp += 'AUG' + ' ';
				break;
			case 9:
				dtGrp += 'SEP' + ' ';
				break;
			case 10:
				dtGrp += 'OCT' + ' ';
				break;
			case 11:
				dtGrp += 'NOV' + ' ';
				break;
			case 12:
				dtGrp += 'DEC' + ' ';
				break;
			}
			dtGrp += dateParts[2];

			return $('<tr><td style="padding: 0;"><div class="dt-grp"><p style="margin: 0;">' + dtGrp + '</p></div></td></tr>');
		}else {
			return null;
		}
	}

	function setLastMsgId() {
		var msgIds = $('.msg-ids');
		if (msgIds === undefined || msgIds.length === 0) {
			$('#last-msg-id').val(-1);
		} else {
			$('#last-msg-id').val($(msgIds[msgIds.length - 1]).val());
		}
	}
</script>
</head>
<body>
	<header id="heading">
		<div id="title">Intra-team Communication System</div>
		<div id="menu-div">
			<img src="##APPLICATION_CONTEXT##/resource/images/refresh.png"
				alt="Reload Page" height="28" width="28" title="Reload Page"
				class="img-btn" id="reload-btn"> ##SPECIAL_APPENDER_BUTTON## <img
				src="##APPLICATION_CONTEXT##/resource/images/logout.png"
				alt="Sign out" height="28" width="28" title="Sign out"
				class="img-btn" id="logout-btn">
		</div>
		<div id="my-name">You are logged in as: ##REALNAME##</div>
	</header>
	<div id="content">
		<table>
			<tbody id="content-body">
			</tbody>
		</table>
	</div>
	<div id="users">
		<div id="users-title">Logged in Users</div>
		<div id="user-list"></div>
	</div>
	<div style="" id="emoji-container"></div>
	<div id="text">
		<form action="##APPLICATION_CONTEXT##/send" method="post"
			id="chat-form">
			<table>
				<tr>
					<td style="width: 89%;">
						<div id="msg-in-box" contenteditable="true"></div> <textarea
							id="msg-in-box-content" name="message" style="display: none;"></textarea>
					</td>
					<td><input type="submit" id="send-btn" value="Send"></td>
				</tr>
			</table>
			<input type="hidden" name="token" id="token" value="##TOKEN_VALUE##">
			<input type="hidden" name="uname" id="uname" value="##UNAME_VALUE##">
			<input type="hidden" id="send-id" value="" name="sendId">
		</form>
	</div>
	<div style="height: 20px; margin-top: 5px; width: 90.4%; border: none;">
		<span id="err-box" style="color: red;"></span>
	</div>
	<input type="hidden" id="last-msg-id" value="-1">
	<input type="hidden" id="page-unload-status" value="close">
</body>
</html>